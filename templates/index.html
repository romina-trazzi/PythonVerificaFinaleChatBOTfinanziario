<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Chatbot Finanziario</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
     <link rel="stylesheet" href="../static/css/main.css">
</head>
<body>
    <div class="container-fluid chat-container">
        <h2 class="text-center mb-3">ðŸ’¬ Chatbot Finanziario</h2>
        <div id="chat-box" class="chat-box">
            <div class="message bot">
                <div class="text">Benvenuto! Scrivi qui sotto la tua domanda: puoi chiedere prezzi di azioni, creare grafici, scaricare report PDF o capire cos'Ã¨ un concetto finanziario.</div>
            </div>
        </div>
        <form id="chat-form" class="d-flex">
            <input type="text" id="chat-input" class="form-control me-2" placeholder="Scrivi una domanda..." required>
            <button class="btn btn-primary" type="submit">Invia</button>
        </form>
        <div id="loading" class="text-center mt-3 d-none">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2">Sto elaborando la tua richiesta...</p>
        </div>
    </div>

    <script>
    const form = document.getElementById("chat-form");
    const input = document.getElementById("chat-input");
    const chatBox = document.getElementById("chat-box");
    const loading = document.getElementById("loading");

    form.addEventListener("submit", function(e) {
        e.preventDefault();
        const message = input.value.trim();
        if (!message) return;
        appendMessage("user", message);
        input.value = "";
        input.disabled = true;
        loading.classList.remove("d-none");
        document.body.style.cursor = "wait";

        fetch("/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message })
        })

        .then(res => res.json())
        .then(data => {
            appendMessage("bot", data.response);
        })
        .catch(err => {
            appendMessage("bot", "Si Ã¨ verificato un errore nella richiesta.");
        })
        .finally(() => {
            input.disabled = false;
            loading.classList.add("d-none");
            document.body.style.cursor = "default";
        });
    });

    function appendMessage(sender, text) {
        const msgDiv = document.createElement("div");
        msgDiv.className = "message " + sender;

        const bubble = document.createElement("div");
        bubble.className = "text";
        bubble.innerHTML = text;

        msgDiv.appendChild(bubble);
        chatBox.appendChild(msgDiv);

        // Se c'Ã¨ un percorso immagine, lo mostriamo come immagine (es. output/charts/abc.png)
        const imageRegex = /(output\/charts\/\S+\.png)/;
        const match = text.match(imageRegex);
        if (match) {
            const img = document.createElement("img");
            img.src = "/" + match[1];  // Flask serve statico
            img.className = "image-response";
            chatBox.appendChild(img);
        }

        chatBox.scrollTop = chatBox.scrollHeight;
    }
    </script>
</body>
</html>

